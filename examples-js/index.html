<!DOCTYPE html>
<script type="module">
  import { Blockfrost, C, Data, Lucid } from "https://unpkg.com/lucid-cardano@0.10.4/web/mod.js"
  import { SendTx } from "/examples-js-fastopt.js"
  console.log('Lucid')
  let apiKey = await fetch("/apikey").then(r => r.text())
  console.log("API Key: " + apiKey)
  const lucid = await Lucid.new(
    new Blockfrost("https://cardano-preview.blockfrost.io/api/v0", apiKey),
    "Preview",
  );
  // Nami wallet integration


  // Assumes you are in a browser environment
  console.log(chrome)
  console.log(window.cardano)
  console.log(window.cardano.nami)
  console.log(window.cardano.lace)
  // console.log(asdf)
  // const api = await window.cardano.nami.enable();
  const api = await window.cardano.lace.enable();
  lucid.selectWallet(api);

  async function mint() {
    const utxos = await lucid.wallet.getUtxos()
    if (utxos.length > 0) {
      console.log(utxos)
      const utxo = utxos[0]
      console.log(utxo)
      const address = await lucid.wallet.address()
      console.log(address)
      const mintingScript = SendTx.getPlutusScriptCborFromTxOutRef(utxo.txHash, utxo.outputIndex)
      console.log(mintingScript.doubleCbor)
      const mintingPolicy = { type: "PlutusV1", script: mintingScript.doubleCbor }
      const policyId = lucid.utils.mintingPolicyToId(mintingPolicy);
      console.log(policyId)
      const assetid = policyId + "484f534b59";
      console.log(assetid)
      const assets = { [assetid]: 1000000000000000n };
      console.log(assets)
      const redeemer = Data.to(0n)
      console.log(redeemer)
      const tx = await lucid.newTx()
        .collectFrom([utxo])
        .mintAssets(assets, redeemer)
        .attachMintingPolicy(mintingPolicy)
        .payToAddress(address, assets)
        .complete()
      console.log(tx)
      const signedTx = await tx.sign().complete();
      console.log(signedTx)
      const txHash = await signedTx.submit();
      console.log(txHash)
    } else {
      console.log("No UTXOs")
    }
  }

  async function burn() {
    const utxos = await lucid.wallet.getUtxos()
    if (utxos.length > 0) {
      console.log(utxos)
      const utxo = utxos[0]
      console.log(utxo)
      const address = await lucid.wallet.address()
      console.log(address)
      const txHash = '41bfb228401cdc0f5d0f5d09bf034fbff584034c947d1b26ae5066146d9f6211'
      const mintingScript = SendTx.getPlutusScriptCborFromTxOutRef(txHash, 0)
      console.log(mintingScript.doubleCbor)
      const mintingPolicy = { type: "PlutusV1", script: mintingScript.doubleCbor }
      const policyId = lucid.utils.mintingPolicyToId(mintingPolicy);
      console.log(policyId)
      const assetid = policyId + "484f534b59";
      console.log(assetid)
      const assets = { [assetid]: -1000000000000000n };
      console.log(assets)
      const redeemer = Data.to(0n)
      console.log(redeemer)
      const tx = await lucid.newTx()
        .collectFrom([utxo])
        .mintAssets(assets, redeemer)
        .attachMintingPolicy(mintingPolicy)
        // .payToAddress(address, assets)
        .complete()
      console.log(tx)
      const signedTx = await tx.sign().complete();
      console.log(signedTx)
      const txHashBurn = await signedTx.submit();
      console.log(txHashBurn)
    } else {
      console.log("No UTXOs")
    }
  }

  // await mint()
  // await burn()



</script>

<body>
  <form action="" method="get">
    <input type="text" name="q" />
    <input type="submit" value="Search" />
  </form>
</body>